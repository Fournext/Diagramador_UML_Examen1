<div class="flex flex-col w-63 h-full bg-gray-50 border-r border-gray-200 shadow-md p-4 space-y-6">

  <!-- Header -->
  <div class="flex justify-between items-center mb-2">
    <h2 class="text-lg font-semibold text-gray-800"> Herramientas UML</h2>
    <button 
      class="text-sm text-red-500 hover:text-red-700 font-medium transition"
      (click)="goHome()">
      ‚¨ÖÔ∏è Salir
    </button>
  </div>

  <!-- Paleta de elementos -->
  <div class="space-y-2">
    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition"
      cdkDrag
      [cdkDragData]="{ type: 'class' }"
      (cdkDragEnded)="onDragEnded($event)">
      üì¶ <span class="ml-1">Clase UML</span>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition"
      cdkDrag
      [cdkDragData]="{ type: 'association' }"
      (cdkDragEnded)="onDragEnded($event)">
       <div class="flex items-center gap-4 w-full justify-center py-1">
          <span class="inline-block align-middle" style="width:100px;height:28px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="103%" height="100%" viewBox="25 -5 165 20">
              <g>
                <path d="M 7 7 L 158.88 7" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10" pointer-events="stroke"/>
                <path d="M 165.88 7 L 158.88 10.5 L 158.88 3.5 Z" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10" pointer-events="all"/>
              </g>
            </svg>
          </span>
          <span class="font-semibold text-base text-gray-900">Asociaci√≥n</span>
        </div>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition flex items-center"
      cdkDrag
      [cdkDragData]="{ type: 'generalization' }"
      (cdkDragEnded)="onDragEnded($event)">
        <div class="flex items-center gap-7 w-full justify-center py-1">
          <span class="inline-block align-middle" style="width:100px;height:28px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="25 5 165 20">
              <g>
                <path d="M 24 18 L 150 18" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10" pointer-events="stroke"/>
                <path d="M 170 18 L 150 28 L 150 8 Z" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10" pointer-events="all"/>
              </g>
            </svg>
          </span>
          <span class="font-semibold text-base text-gray-900">Herencia</span>
        </div>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition"
      cdkDrag
      [cdkDragData]="{ type: 'aggregation' }"
      (cdkDragEnded)="onDragEnded($event)">
        <div class="flex items-center gap-4 w-full justify-center py-1">
          <span class="inline-block align-middle" style="width:100px;height:28px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="110%" height="100%" viewBox="25 5 165 20">
              <g>
                <path d="M 32 18 L 140 18" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10" pointer-events="stroke" />
                <polygon points="160,18 150,28 140,18 150,8" fill="#fff" stroke="#222" stroke-width="2.8" />
              </g>
            </svg>
          </span>
          <span class="font-semibold text-base text-gray-900">Agregaci√≥n</span>
        </div>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition"
      cdkDrag
      [cdkDragData]="{ type: 'composition' }"
      (cdkDragEnded)="onDragEnded($event)">
        <div class="flex items-center gap-4 w-full justify-center py-1">
          <span class="inline-block align-middle" style="width:100px;height:20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="115%" height="100%" viewBox="20 5 165 20">
              <g>
                <path d="M 32 18 L 140 18" fill="none" stroke="#222" stroke-width="2.8" stroke-miterlimit="10" pointer-events="stroke" />
                <polygon points="160,18 150,28 140,18 150,8" fill="#222" stroke="#222" stroke-width="2.8" />
              </g>
            </svg>
          </span>
          <span class="font-semibold text-base text-gray-900">Composici√≥n</span>
        </div>
    </div>

    <div
      class="palette-item cursor-pointer bg-white border rounded-lg shadow-sm px-3 py-2 hover:bg-purple-50 transition flex items-center"
      cdkDrag
      [cdkDragData]="{ type: 'dependency' }"
      (cdkDragEnded)="onDragEnded($event)">
        <div class="flex items-center gap-4 w-full justify-center py-1">
          <span class="inline-block align-middle" style="width:100px;height:28px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="110%" height="100%" viewBox="20 5 165 20">
              <g>
                <path d="M 32 18 L 150 18" fill="none" stroke="#888" stroke-width="2.8" stroke-miterlimit="10" stroke-dasharray="4 3" pointer-events="stroke" />
                <path d="M 170 18 L 150 28 L 150 8 Z" fill="none" stroke="#888" stroke-width="2.8" stroke-miterlimit="10" pointer-events="all" />
              </g>
            </svg>
          </span>
          <span class="font-semibold text-base text-gray-900">Dependencia</span>
        </div>
    </div>
  </div>


  <!-- Men√∫ comprimido de acciones -->
  <div class="w-full">
    <button class="w-full bg-gray-200 text-gray-800 rounded-lg py-2 font-medium mb-2 flex items-center justify-center gap-1" (click)="showActions = !showActions">
      <span class="text-center">Exportaciones</span>
      <span>{{ showActions ? '‚ñ≤' : '‚ñº' }}</span>
    </button>
    @if (showActions) {
      <div class="space-y-2">
        <button
          class="w-full bg-blue-500 text-white rounded-lg py-2 font-medium hover:bg-blue-600 transition"
          (click)="onSaveClicked()">
          üíæ Exportar a Backend
        </button>
        <button
          class="w-full bg-green-500 text-white rounded-lg py-2 font-medium hover:bg-green-600 transition"
          (click)="exportImage()">
          üñºÔ∏è Exportar como Imagen
        </button>
        <button
          class="w-full bg-yellow-500 text-white rounded-lg py-2 font-medium hover:bg-yellow-600 transition"
          (click)="exportSql()">
          üíΩ Exportar como SQL
        </button>
      </div>
    }
  </div>
  <button
    class="w-full bg-purple-600 hover:bg-purple-700 text-white rounded-lg py-2 font-medium shadow-md transition"
    (click)="copyRoomCode()">
    üìã Copiar c√≥digo de sala
  </button>
  @if (copied() == true) {
    <small class="text-green-600 mt-1 block text-center">¬°Copiado!</small>
  }

  <!-- Chatbot panel -->
  <div class="chatbot-panel bg-white rounded-lg shadow-md p-3 space-y-2">
    <h4 class="font-semibold text-gray-700">ü§ñ Generar modelo</h4>

    <div class="flex space-x-2">
      <textarea [(ngModel)]="prompt"
                class="w-full border rounded-md p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none resize-none"
                placeholder="Describe tu modelo aqu√≠..."
                rows="3"></textarea>

      <button
        (click)="toggleVoiceInput()"
        class="px-3 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition">
        @if (recognizing()==true) {
          <span>‚èπÔ∏è</span>
        }
        @else {
          <span>üé§</span>
        }
      </button>
    </div>

    <button
      class="w-full bg-purple-600 text-white rounded-lg py-2 font-medium hover:bg-purple-700 transition"
      (click)="onGenerate()">
      Generar
    </button>
  </div>


  <!-- Panel de validaciones -->
  <div class="validation-panel bg-white rounded-lg shadow-md p-2">
    <div class="flex justify-between items-center cursor-pointer"
         (click)="toggleValidationPanel()">
      <h4 class="font-semibold text-gray-700">üîç Sugerencias del modelo</h4>
      <span class="text-xl">
        @if (validationCollapsed()) {
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#8B5CF6" stroke-width="2"/>
            <line x1="12" y1="8" x2="12" y2="16" stroke="#8B5CF6" stroke-width="2"/>
            <line x1="8" y1="12" x2="16" y2="12" stroke="#8B5CF6" stroke-width="2"/>
          </svg>
        } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="#8B5CF6" stroke-width="2"/>
            <line x1="8" y1="12" x2="16" y2="12" stroke="#8B5CF6" stroke-width="2"/>
          </svg>
        }
      </span>
    </div>

    <button
      class="mt-2 w-full bg-green-500 text-white rounded-lg py-1.5 font-medium hover:bg-green-600 transition"
      (click)="analyzeNow()"
      [disabled]="analyzingModel()">
      <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1" width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="#fff" stroke-width="2"/><line x1="16" y1="16" x2="21" y2="21" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>
      @if (!analyzingModel()) {
        <span>Analizar modelo</span>
      }
      @if (analyzingModel()) {
        <span>Analizando...</span>
      }
    </button>

     @if (!validationCollapsed()) {
      <div class="mt-3 text-sm text-gray-700 space-y-3 max-h-40 overflow-y-auto pr-2">
        @if (analyzingModel()) {
          <p class="italic text-purple-500 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="inline-block mr-1 animate-spin" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="#A78BFA" stroke-width="4" opacity="0.3"/>
              <path d="M12 2a10 10 0 0 1 10 10" stroke="#8B5CF6" stroke-width="4" stroke-linecap="round"/>
            </svg>
            Analizando sugerencias del modelo...
          </p>
        } @else if (!validationResult()) {
          <p class="italic text-gray-400">No hay validaciones a√∫n.</p>
        } @else {
          <!-- Validas -->
          <div>
            <h5 class="text-green-600 font-semibold mb-1">‚úÖ Relaciones v√°lidas</h5>
            <ul class="list-disc pl-5 space-y-1">
              @for (v of validationResult().analysis.validas; track v) {
                <li>
                  <strong>{{ v.relacion }}</strong><br />
                  <small class="text-gray-600">{{ v.razon }}</small>
                </li>
              }
            </ul>
          </div>

          <!-- Errores -->
          <div>
            <h5 class="text-red-600 font-semibold mb-1">‚ùå Errores</h5>
            <ul class="list-disc pl-5 space-y-2">
              @for (e of validationResult().analysis.errores; track e) {
                <li>
                  <strong>{{ e.relacion }}</strong><br />
                  <small class="text-gray-600">{{ e.problema }}</small><br />
                  <em class="text-purple-600">üí° Sugerencia: {{ e.sugerencia }}</em>
                </li>
              }
            </ul>
          </div>
        }
      </div>
    }
  </div>
</div>
